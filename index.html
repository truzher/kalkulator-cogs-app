<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalkulator COGS F&B by HABB</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="container">
    <!-- Bagian Autentikasi -->
    <div id="auth-container">
        <div class="hero-section">
            <h1>Hitung HPP Jadi Gampang</h1>
            <p class="subtitle">Ucapkan selamat tinggal pada spreadsheet rumit. Atur harga jual, lacak biaya, dan maksimalkan profit bisnismu dengan mudah.</p>
        </div>
        <div class="auth-box">
            <form id="login-form" class="auth-form">
                <h2>Masuk Akun</h2>
                <input type="email" id="login-email" placeholder="Email kamu" required>
                <input type="password" id="login-password" placeholder="Password" required>
                <button type="submit">Login</button>
            </form>
            <hr>
            <form id="signup-form" class="auth-form">
                <h2>Belum Punya Akun? Daftar Gratis!</h2>
                <input type="email" id="signup-email" placeholder="Email kamu" required>
                <input type="password" id="signup-password" placeholder="Password (min. 6 karakter)" required>
                <button type="submit" class="button-secondary">Daftar Sekarang</button>
            </form>
        </div>
    </div>

    <!-- Bagian Aplikasi Utama -->
    <div id="app-container" class="hidden">
        <header class="app-header">
            <h1 class="app-title">Kalkulator HPP</h1>
            <div class="user-menu">
                <span id="user-email-display"></span>
                <button id="logout-button">Logout</button>
            </div>
        </header>
        
        <nav class="main-nav">
            <button class="nav-button active" data-page="page-kalkulator">Kalkulator</button>
            <button class="nav-button" data-page="page-produk">Daftar Produk</button>
            <button class="nav-button" data-page="page-bahan">Master Bahan</button>
        </nav>

        <main id="app-content">
            <div id="page-kalkulator" class="page active">
                <div class="section">
                    <h2>Buat Resep & Hitung HPP</h2>
                    <form id="hpp-form">
                        <div class="input-group">
                             <div style="flex: 1.5;">
                                <label for="jenis-produk-input">Tipe Produk</label>
                                <select id="jenis-produk-input">
                                    <option value="Produk Jadi">Produk Jadi (Dijual)</option>
                                    <option value="Produk Setengah Jadi">Produk Setengah Jadi (Biang)</option>
                                </select>
                            </div>
                            <div style="flex: 1;">
                                <label for="produk-kategori">Kategori</label>
                                <select id="produk-kategori">
                                    <option value="Minuman">Minuman</option>
                                    <option value="Makanan">Makanan</option>
                                    <option value="Lainnya">Lainnya</option>
                                </select>
                            </div>
                        </div>
                        <label for="produk-nama">Nama Produk</label>
                        <input type="text" id="produk-nama" placeholder="cth: Es Kopi Susu Gula Aren" required>
                        
                        <div id="hasil-jadi-container" class="hidden">
                             <h3>Info Hasil Jadi (Yield)</h3>
                             <div class="input-group">
                                 <div>
                                     <label for="hasil-jadi-jumlah">Jumlah Hasil Jadi</label>
                                     <input type="number" id="hasil-jadi-jumlah" placeholder="cth: 1000">
                                 </div>
                                 <div>
                                     <label for="hasil-jadi-satuan">Satuan Hasil Jadi</label>
                                     <input type="text" id="hasil-jadi-satuan" placeholder="cth: ml, gram">
                                 </div>
                             </div>
                        </div>

                        <h3>Bahan Resep</h3>
                        <div class="table-wrapper">
                            <table id="resep-table">
                                <thead><tr><th>Bahan</th><th>Jumlah</th><th>Biaya</th><th>Aksi</th></tr></thead>
                                <tbody id="resep-table-body"></tbody>
                            </table>
                        </div>
                        <button type="button" id="add-resep-item-btn">+ Tambah Bahan</button>
                        <hr>

                        <div id="harga-jual-container">
                            <h3>Biaya & Penentuan Harga</h3>
                            <div class="input-group">
                                <div style="flex: 2;"><label for="overhead-cost">Biaya Overhead</label><input type="number" id="overhead-cost" placeholder="0"></div>
                                <div style="flex: 1;"><label for="overhead-type">Tipe</label><select id="overhead-type"><option value="nominal">Rp</option><option value="persen">%</option></select></div>
                            </div>
                            <div class="input-group">
                                <div><label for="labor-cost">Tenaga Kerja/Porsi (Rp)</label><input type="number" id="labor-cost" placeholder="0"></div>
                                <div><label for="error-cost-percent">Error Cost (%)</label><input type="number" id="error-cost-percent" placeholder="0"></div>
                            </div>
                            <div class="input-group">
                                <div><label for="target-margin-percent">Target Margin (%)</label><input type="number" id="target-margin-percent" placeholder="0"></div>
                                <div><label for="harga-jual-aktual">Harga Jual Aktual (Final)</label><input type="number" id="harga-jual-aktual" placeholder="0" required></div>
                            </div>
                        </div>

                        <div class="hpp-summary">
                            <h3>Total HPP (Modal): <span id="total-cogs-display">Rp 0,00</span></h3>
                            <div id="saran-harga-wrapper">
                                <h3 class="saran-harga">Saran Harga Jual: <span id="saran-harga-display">Rp 0,00</span></h3>
                                <p>Profit: <span id="profit-display">Rp 0,00</span> (<span id="profit-percent-display">0.00</span>%)</p>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="button" id="reset-hpp-btn" class="button-secondary">Reset Form</button>
                            <button type="submit">Simpan Produk</button>
                        </div>
                    </form>
                </div>
            </div>
            
            <div id="page-produk" class="page">
                <div class="section">
                    <h2>Daftar Produk Tersimpan</h2>
                    <div class="table-wrapper">
                        <table id="produk-table">
                            <thead><tr><th>Nama Produk</th><th>Kategori</th><th>Harga Jual</th><th>Aksi</th></tr></thead>
                            <tbody id="produk-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="page-bahan" class="page">
                 <div class="section">
                    <h2>Master Bahan Baku</h2>
                    <form id="master-bahan-form">
                        <label for="bahan-nama">Nama Bahan</label>
                        <input type="text" id="bahan-nama" placeholder="cth: Gula Aren Cair" required>
                        <label for="harga-beli-kemasan">Harga Beli Kemasan (Rp)</label>
                        <input type="number" id="harga-beli-kemasan" placeholder="0" required>
                        <div class="input-group">
                            <div><label for="isi-kemasan">Isi</label><input type="number" id="isi-kemasan" placeholder="0" required></div>
                            <div><label for="satuan-kemasan">Satuan</label><input type="text" id="satuan-kemasan" placeholder="cth: ml, gram" required></div>
                        </div>
                        <button type="submit">Simpan Bahan</button>
                    </form>
                    <div class="table-wrapper">
                        <table id="master-bahan-table">
                            <thead><tr><th>Nama Bahan</th><th>Harga/Satuan Dasar</th><th>Aksi</th></tr></thead>
                            <tbody id="master-bahan-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- Modal Edit Bahan Baku -->
<div id="edit-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <h2>Edit Bahan Baku</h2>
        <form id="edit-bahan-form">
            <input type="hidden" id="edit-bahan-id">
            <label for="edit-bahan-nama">Nama Bahan</label>
            <input type="text" id="edit-bahan-nama" required>
            <label for="edit-harga-beli-kemasan">Harga Beli Kemasan (Rp)</label>
            <input type="number" id="edit-harga-beli-kemasan" required>
            <div class="input-group">
                <div><label for="edit-isi-kemasan">Isi</label><input type="number" id="edit-isi-kemasan" required></div>
                <div><label for="edit-satuan-kemasan">Satuan</label><input type="text" id="edit-satuan-kemasan" required></div>
            </div>
            <div class="modal-actions">
                <button type="button" id="cancel-edit-btn">Batal</button>
                <button type="submit">Simpan Perubahan</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal Pilih Bahan -->
<div id="pilih-bahan-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <h2>Pilih Bahan</h2>
        <input type="text" id="search-bahan-input" placeholder="Ketik untuk mencari bahan...">
        <div class="bahan-source-tabs">
            <button class="bahan-source-btn active" data-source="bahan_baku">Bahan Mentah</button>
            <button class="bahan-source-btn" data-source="produk_setengah_jadi">Produk Setengah Jadi (Biang)</button>
        </div>
        <ul id="bahan-search-results"></ul>
        <div class="modal-actions">
            <button type="button" id="buat-bahan-baru-cepat-btn" class="button-secondary">+ Buat Bahan Mentah Baru</button>
            <button type="button" id="cancel-pilih-bahan-btn">Batal</button>
        </div>
    </div>
</div>

<!-- Modal Tambah Bahan Cepat -->
<div id="tambah-bahan-cepat-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <h2>Tambah Bahan Baku Baru</h2>
        <p>Bahan ini akan langsung ditambahkan ke Master Bahan Baku.</p>
        <form id="master-bahan-cepat-form">
            <label for="bahan-nama-cepat">Nama Bahan</label>
            <input type="text" id="bahan-nama-cepat" required>
            <label for="harga-beli-kemasan-cepat">Harga Beli Kemasan (Rp)</label>
            <input type="number" id="harga-beli-kemasan-cepat" placeholder="0" required>
            <div class="input-group">
                <div><label for="isi-kemasan-cepat">Isi</label><input type="number" id="isi-kemasan-cepat" placeholder="0" required></div>
                <div><label for="satuan-kemasan-cepat">Satuan</label><input type="text" id="satuan-kemasan-cepat" placeholder="cth: ml" required></div>
            </div>
            <div class="modal-actions">
                <button type="button" id="cancel-tambah-cepat-btn">Batal</button>
                <button type="submit">Simpan</button>
            </div>
        </form>
    </div>
</div>

<!-- Script Tags -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="app.js"></script>

</body>
</html>
```

### File 2: `style.css` (Penyesuaian untuk Fitur Baru)
Cici menambahkan beberapa style untuk pop-up pencarian bahan yang baru agar tampilannya tetap keren.

```css
/* === FONT MODERN DARI GOOGLE FONTS === */
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

/* === CSS VARIABLES UNTUK TEMA WARNA (LIGHT MODE) === */
:root {
    --primary-color: #14b8a6; /* Tosca Segar */
    --primary-hover: #0d9488;
    --background-color: #f8f9fa;
    --surface-color: #ffffff;
    --border-color: #dee2e6;
    --text-color: #212529;
    --text-secondary: #6c757d;
    --danger-color: #dc3545;
    --warning-color: #ffc107;
    --success-color: #28a745;
    --shadow: 0 4px 15px rgba(0, 0, 0, 0.07);
}

/* === GENERAL STYLING === */
body {
    font-family: 'Inter', sans-serif;
    line-height: 1.6;
    background-color: var(--background-color);
    color: var(--text-color);
    margin: 0;
    padding: 15px;
}
.container { max-width: 1200px; margin: 20px auto; }
h1, h2, h3 { font-weight: 700; letter-spacing: -0.5px; }
h1 { font-size: 2.2rem; }
h2 { font-size: 1.5rem; color: var(--primary-color); margin-bottom: 20px; }
h3 { font-size: 1.1rem; margin-top: 25px; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px;}
hr { border: 0; border-top: 1px solid var(--border-color); margin: 25px 0; }

/* === HERO & AUTH SECTION === */
.hero-section { text-align: center; padding: 20px 0; margin-bottom: 30px; }
.hero-section .subtitle { font-size: 1.1rem; color: var(--text-secondary); max-width: 600px; margin: 15px auto 0; }
.auth-box { background-color: var(--surface-color); padding: 30px; border-radius: 12px; max-width: 450px; margin: auto; border: 1px solid var(--border-color); box-shadow: var(--shadow); }

/* === FORM & INPUT STYLING === */
label { display: block; margin-bottom: 8px; font-weight: 500; font-size: 0.9rem; color: var(--text-secondary); }
input[type="text"], input[type="email"], input[type="password"], input[type="number"], select {
    width: 100%;
    padding: 12px 15px;
    margin-bottom: 20px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    box-sizing: border-box;
    font-size: 1rem;
    background-color: #ffffff;
    color: var(--text-color);
    transition: border-color 0.2s, box-shadow 0.2s;
}
input:focus, select:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(20, 184, 166, 0.4); }

/* === BUTTON STYLING === */
button { width: 100%; padding: 12px 15px; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.2s; }
button:hover { transform: translateY(-2px); }
button[type="submit"] { background-color: var(--primary-color); color: white; }
button[type="submit"]:hover { background-color: var(--primary-hover); }
.button-secondary { background-color: var(--text-secondary); color: white; }
.button-secondary:hover { background-color: #5a6268; }

/* === APP LAYOUT === */
.hidden { display: none !important; }
.app-header { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 15px; margin-bottom: 20px; }
.app-title { margin: 0; }
.user-menu { display: flex; align-items: center; gap: 15px; }
#logout-button { width: auto; padding: 8px 15px; }

/* === NAVIGASI UTAMA === */
.main-nav { display: flex; gap: 8px; margin-bottom: 25px; background-color: #e9ecef; padding: 6px; border-radius: 10px; overflow-x: auto; }
.nav-button { flex: 1; padding: 10px 15px; background-color: transparent; color: var(--text-secondary); border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: color 0.2s, background-color 0.2s, box-shadow 0.2s; white-space: nowrap; }
.nav-button:hover { background-color: rgba(0,0,0,0.05); color: var(--text-color); }
.nav-button.active { background-color: var(--surface-color); color: var(--primary-color); box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); }

/* === KONTEN HALAMAN (PAGE) === */
.page { display: none; }
.page.active { display: block; }
.section { background-color: var(--surface-color); padding: 25px; border-radius: 12px; border: 1px solid #e9ecef; box-shadow: var(--shadow); }

/* === TABLE STYLING === */
.table-wrapper { overflow-x: auto; }
table { width: 100%; border-collapse: collapse; margin-top: 20px; }
th, td { padding: 12px 10px; text-align: left; vertical-align: middle; border-bottom: 1px solid var(--border-color); white-space: nowrap; }
thead { color: var(--text-secondary); text-transform: uppercase; font-size: 0.8rem; background-color: #f8f9fa; }
td button { font-size: 12px; padding: 6px 10px; margin-right: 5px; width: auto; }
.button-delete { background-color: var(--danger-color); color: white; }
.button-edit { background-color: var(--warning-color); color: var(--dark-color); }

/* === KALKULATOR HPP STYLING === */
#add-resep-item-btn { width: auto; padding: 10px 20px; background-color: var(--primary-color); margin-top: 15px; }
.hpp-summary { background-color: #e9ecef; padding: 15px; border-radius: 8px; margin-top: 20px; text-align: right; }
.hpp-summary h3 { margin: 0; font-size: 1.2rem; }
.hpp-summary p { margin: 5px 0 0; color: var(--text-secondary); }
.form-actions { display: flex; gap: 10px; margin-top: 20px; }
.form-actions button { flex: 1; }
#hpp-form button[type="submit"] { background-color: var(--success-color); }

/* === MODAL STYLING === */
.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; padding: 15px; }
.modal-content { background: var(--surface-color); padding: 30px; border-radius: 12px; width: 100%; max-width: 600px; border: 1px solid var(--border-color); }
.modal-actions { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
#cancel-edit-btn, #cancel-pilih-bahan-btn, #cancel-tambah-cepat-btn { background-color: var(--text-secondary); color: white; }

/* === MODAL PENCARIAN BAHAN === */
#bahan-search-results { list-style: none; padding: 0; margin: 20px 0; max-height: 300px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px; }
#bahan-search-results li { padding: 12px 15px; cursor: pointer; border-bottom: 1px solid var(--border-color); transition: background-color 0.2s; display: flex; justify-content: space-between; align-items: center; }
#bahan-search-results li:last-child { border-bottom: none; }
#bahan-search-results li:hover { background-color: rgba(20, 184, 166, 0.1); }
#bahan-search-results li small { color: var(--text-secondary); font-size: 0.8rem; background-color: #e9ecef; padding: 2px 6px; border-radius: 4px; }
.bahan-source-tabs { display: flex; border-bottom: 1px solid var(--border-color); margin-top: 15px; }
.bahan-source-btn { flex: 1; padding: 10px; border: none; background: none; color: var(--text-secondary); font-weight: 600; cursor: pointer; border-bottom: 3px solid transparent; transition: color 0.2s, border-color 0.2s; }
.bahan-source-btn.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }

/* === DESKTOP & TABLET STYLES (MEDIA QUERIES) === */
@media (min-width: 768px) {
    .app-header { flex-wrap: nowrap; }
    .nav-button { flex: 0 1 auto; padding: 12px 20px; }
    .modal-actions { flex-direction: row; }
}
```

### File 3: `app.js` (Versi dengan Otak Baru)
Ini adalah "otak" aplikasi yang sudah Cici rombak total untuk menangani semua logika baru yang kita diskusikan.

```javascript
document.addEventListener('DOMContentLoaded', () => {
    // === KONFIGURASI SUPABASE ===
    const SUPABASE_URL = 'https://ubfbsmhyshosiihaewis.supabase.co'; 
    const SUPABASE_ANON_KEY = 'PASTE_KUNCI_ANON_LOE_YANG_BENAR_DI_SINI';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // === VARIABEL GLOBAL ===
    let currentUser = null;
    let masterBahanList = [];
    let produkSetengahJadiList = [];
    let isEditingProduk = false;
    let editingProdukId = null;
    let resepRowTarget = null; // Menyimpan baris resep mana yang sedang diisi

    // === DOM ELEMENTS ===
    const authContainer = document.getElementById('auth-container');
    const appContainer = document.getElementById('app-container');
    const loginForm = document.getElementById('login-form');
    const signupForm = document.getElementById('signup-form');
    const logoutButton = document.getElementById('logout-button');
    const userEmailDisplay = document.getElementById('user-email-display');
    const mainNav = document.querySelector('.main-nav');
    const pages = document.querySelectorAll('.page');
    
    // Halaman Master Bahan
    const masterBahanForm = document.getElementById('master-bahan-form');
    const masterBahanTableBody = document.getElementById('master-bahan-table-body');
    
    // Halaman Kalkulator
    const hppForm = document.getElementById('hpp-form');
    const jenisProdukInput = document.getElementById('jenis-produk-input');
    const produkKategoriInput = document.getElementById('produk-kategori');
    const produkNamaInput = document.getElementById('produk-nama');
    const hasilJadiContainer = document.getElementById('hasil-jadi-container');
    const hasilJadiJumlahInput = document.getElementById('hasil-jadi-jumlah');
    const hasilJadiSatuanInput = document.getElementById('hasil-jadi-satuan');
    const addResepItemBtn = document.getElementById('add-resep-item-btn');
    const resepTableBody = document.getElementById('resep-table-body');
    const hargaJualContainer = document.getElementById('harga-jual-container');
    const overheadCostInput = document.getElementById('overhead-cost');
    const overheadTypeInput = document.getElementById('overhead-type');
    const laborCostInput = document.getElementById('labor-cost');
    const errorCostPercentInput = document.getElementById('error-cost-percent');
    const targetMarginPercentInput = document.getElementById('target-margin-percent');
    const hargaJualAktualInput = document.getElementById('harga-jual-aktual');
    const totalCogsDisplay = document.getElementById('total-cogs-display');
    const saranHargaWrapper = document.getElementById('saran-harga-wrapper');
    const saranHargaDisplay = document.getElementById('saran-harga-display');
    const profitDisplay = document.getElementById('profit-display');
    const profitPercentDisplay = document.getElementById('profit-percent-display');
    const resetHppBtn = document.getElementById('reset-hpp-btn');

    // Halaman Daftar Produk
    const produkTableBody = document.getElementById('produk-table-body');

    // Modal Edit Bahan Baku
    const editModal = document.getElementById('edit-modal');
    const editBahanForm = document.getElementById('edit-bahan-form');
    const cancelEditBtn = document.getElementById('cancel-edit-btn');

    // Modal Pilih Bahan
    const pilihBahanModal = document.getElementById('pilih-bahan-modal');
    const searchBahanInput = document.getElementById('search-bahan-input');
    const bahanSearchResults = document.getElementById('bahan-search-results');
    const cancelPilihBahanBtn = document.getElementById('cancel-pilih-bahan-btn');
    const bahanSourceTabs = document.querySelector('.bahan-source-tabs');
    const buatBahanBaruCepatBtn = document.getElementById('buat-bahan-baru-cepat-btn');

    // Modal Tambah Bahan Cepat
    const tambahBahanCepatModal = document.getElementById('tambah-bahan-cepat-modal');
    const masterBahanCepatForm = document.getElementById('master-bahan-cepat-form');
    const cancelTambahCepatBtn = document.getElementById('cancel-tambah-cepat-btn');

    // === FUNGSI UTAMA ===
    const updateUI = (user) => {
        if (user) {
            currentUser = user;
            authContainer.classList.add('hidden');
            appContainer.classList.remove('hidden');
            userEmailDisplay.textContent = user.email;
            loadBahanBaku();
            loadProduk();
        } else {
            currentUser = null;
            authContainer.classList.remove('hidden');
            appContainer.classList.add('hidden');
        }
    };

    // === FUNGSI-FUNGSI APLIKASI ===

    const formatRupiah = (angka) => {
        if (isNaN(angka)) return 'Rp 0,00';
        return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 2 }).format(angka);
    };

    const loadBahanBaku = async () => {
        const { data, error } = await supabaseClient.from('bahan_baku').select('*').order('created_at', { ascending: false });
        if (error) { console.error('Error mengambil data bahan baku:', error); return; }
        masterBahanList = data;
        masterBahanTableBody.innerHTML = '';
        data.forEach(bahan => {
            const hargaPerSatuanDasar = (bahan.isi_kemasan > 0) ? (bahan.harga_beli_kemasan / bahan.isi_kemasan) : 0;
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${bahan.nama}</td>
                <td>${formatRupiah(hargaPerSatuanDasar)} / ${bahan.satuan_kemasan}</td>
                <td>
                    <button class="button-edit" data-id="${bahan.id}">Edit</button>
                    <button class="button-delete" data-id="${bahan.id}">Hapus</button>
                </td>
            `;
            masterBahanTableBody.appendChild(row);
        });
    };

    const simpanBahanBaku = async (event, isCepat = false) => {
        event.preventDefault();
        if (!currentUser) { alert('Sesi tidak ditemukan.'); return; }
        
        const formPrefix = isCepat ? '-cepat' : '';
        const formElement = isCepat ? masterBahanCepatForm : masterBahanForm;

        const nama = document.getElementById(`bahan-nama${formPrefix}`).value;
        const harga_beli_kemasan = document.getElementById(`harga-beli-kemasan${formPrefix}`).value;
        const isi_kemasan = document.getElementById(`isi-kemasan${formPrefix}`).value;
        const satuan_kemasan = document.getElementById(`satuan-kemasan${formPrefix}`).value;
        
        const { data, error } = await supabaseClient.from('bahan_baku').insert([{ nama, harga_beli_kemasan, isi_kemasan, satuan_kemasan, user_id: currentUser.id }]).select();
        
        if (error) { 
            console.error('Error menyimpan bahan baku:', error); 
            alert('Gagal menyimpan bahan!'); 
        } else { 
            formElement.reset(); 
            await loadBahanBaku();
            if (isCepat) {
                tambahBahanCepatModal.classList.add('hidden');
                tampilkanHasilPencarian(nama, 'bahan_baku');
            }
        }
    };

    const hapusBahanBaku = async (id) => {
        if (confirm("Yakin mau hapus bahan ini?")) {
            const { error } = await supabaseClient.from('bahan_baku').delete().eq('id', id);
            if (error) { console.error('Error menghapus bahan baku:', error); alert('Gagal menghapus bahan!'); } 
            else { loadBahanBaku(); }
        }
    };

    const openEditModal = async (id) => {
        const { data, error } = await supabaseClient.from('bahan_baku').select('*').eq('id', id).single();
        if (error) { console.error('Error mengambil data untuk diedit:', error); return; }
        document.getElementById('edit-bahan-id').value = data.id;
        document.getElementById('edit-bahan-nama').value = data.nama;
        document.getElementById('edit-harga-beli-kemasan').value = data.harga_beli_kemasan;
        document.getElementById('edit-isi-kemasan').value = data.isi_kemasan;
        document.getElementById('edit-satuan-kemasan').value = data.satuan_kemasan;
        editModal.classList.remove('hidden');
    };

    const simpanPerubahanBahan = async (event) => {
        event.preventDefault();
        const id = document.getElementById('edit-bahan-id').value;
        const nama = document.getElementById('edit-bahan-nama').value;
        const harga_beli_kemasan = document.getElementById('edit-harga-beli-kemasan').value;
        const isi_kemasan = document.getElementById('edit-isi-kemasan').value;
        const satuan_kemasan = document.getElementById('edit-satuan-kemasan').value;
        const { error } = await supabaseClient.from('bahan_baku').update({ nama, harga_beli_kemasan, isi_kemasan, satuan_kemasan }).eq('id', id);
        if (error) { console.error('Error menyimpan perubahan:', error); alert('Gagal menyimpan perubahan!'); } 
        else { editModal.classList.add('hidden'); loadBahanBaku(); }
    };

    const addBahanFromModal = (bahan) => {
        const row = document.createElement('tr');
        row.dataset.bahanId = bahan.id;
        row.dataset.source = bahan.source;
        row.innerHTML = `
            <td>${bahan.nama}</td>
            <td><input type="number" class="jumlah-resep" placeholder="0" min="0"></td>
            <td class="biaya-resep-display">Rp 0,00</td>
            <td><button type="button" class="button-delete hapus-resep-item">X</button></td>
        `;
        resepTableBody.appendChild(row);
        updatePerhitunganTotal();
    };

    const updatePerhitunganTotal = () => {
        let totalBiayaBahan = 0;
        resepTableBody.querySelectorAll('tr').forEach(row => {
            const jumlahInput = row.querySelector('.jumlah-resep');
            const biayaDisplay = row.querySelector('.biaya-resep-display');
            const bahanId = row.dataset.bahanId;
            const source = row.dataset.source;
            const jumlah = parseFloat(jumlahInput.value) || 0;
            
            const listToSearch = source === 'bahan_baku' ? masterBahanList : produkSetengahJadiList;
            const bahanTerpilih = listToSearch.find(b => b.id === bahanId);

            if (bahanTerpilih) {
                let hargaPerSatuan = 0;
                if(source === 'bahan_baku'){
                    if(bahanTerpilih.isi_kemasan > 0) hargaPerSatuan = bahanTerpilih.harga_beli_kemasan / bahanTerpilih.isi_kemasan;
                } else {
                    const hppBahanBiang = hitungHppProduk(bahanTerpilih);
                    if(bahanTerpilih.hasil_jadi_jumlah > 0) {
                        hargaPerSatuan = hppBahanBiang / bahanTerpilih.hasil_jadi_jumlah;
                    }
                }

                const biayaBahan = jumlah * hargaPerSatuan;
                biayaDisplay.textContent = formatRupiah(biayaBahan);
                totalBiayaBahan += biayaBahan;
            } else {
                biayaDisplay.textContent = 'Rp 0,00';
            }
        });
        
        const overheadValue = parseFloat(overheadCostInput.value) || 0;
        const overheadType = overheadTypeInput.value;
        let overheadCost = 0;
        if (overheadType === 'persen') {
            overheadCost = totalBiayaBahan * (overheadValue / 100);
        } else {
            overheadCost = overheadValue;
        }

        const labor = parseFloat(laborCostInput.value) || 0;
        const biayaProduksi = totalBiayaBahan + overheadCost + labor;
        const errorPercent = parseFloat(errorCostPercentInput.value) || 0;
        const errorCost = biayaProduksi * (errorPercent / 100);
        const totalCogs = biayaProduksi + errorCost;
        totalCogsDisplay.textContent = formatRupiah(totalCogs);
        
        const marginPercent = parseFloat(targetMarginPercentInput.value) || 0;
        let saranHarga = 0;
        if (marginPercent < 100 && marginPercent >= 0) {
            saranHarga = totalCogs / (1 - (marginPercent / 100));
        } else if (totalCogs > 0) {
            saranHarga = totalCogs;
        }
        saranHargaDisplay.textContent = formatRupiah(saranHarga);
        
        const hargaJualAktual = parseFloat(hargaJualAktualInput.value) || 0;
        if (hargaJualAktual === 0 && saranHarga > 0) {
            hargaJualAktualInput.value = Math.ceil(saranHarga / 1000) * 1000;
        }
        
        const profit = hargaJualAktual - totalCogs;
        const profitPercent = hargaJualAktual > 0 ? (profit / hargaJualAktual) * 100 : 0;
        profitDisplay.textContent = formatRupiah(profit);
        profitPercentDisplay.textContent = profitPercent.toFixed(2);
    };

    const simpanProduk = async (event) => {
        event.preventDefault();
        if (!currentUser) { alert('Sesi tidak ditemukan.'); return; }
        const namaProduk = produkNamaInput.value;
        if (!namaProduk) { alert('Nama produk tidak boleh kosong!'); return; }
        const resepItems = [];
        resepTableBody.querySelectorAll('tr').forEach(row => {
            const bahanId = row.dataset.bahanId;
            const jumlah = parseFloat(row.querySelector('.jumlah-resep').value) || 0;
            if (bahanId && jumlah > 0) {
                resepItems.push({ bahan_id: bahanId, jumlah: jumlah, source: row.dataset.source });
            }
        });
        if (resepItems.length === 0) { alert('Resep tidak boleh kosong!'); return; }

        const produkData = {
            nama_produk: namaProduk,
            resep: resepItems,
            jenis_produk: jenisProdukInput.value,
            kategori: produkKategoriInput.value,
            hasil_jadi_jumlah: parseFloat(hasilJadiJumlahInput.value) || 0,
            hasil_jadi_satuan: hasilJadiSatuanInput.value,
            overhead_cost: parseFloat(overheadCostInput.value) || 0,
            overhead_cost_type: overheadTypeInput.value,
            labor_cost: parseFloat(laborCostInput.value) || 0,
            error_cost_percent: parseFloat(errorCostPercentInput.value) || 0,
            target_margin_percent: parseFloat(targetMarginPercentInput.value) || 0,
            harga_jual_aktual: parseFloat(hargaJualAktualInput.value) || 0,
            user_id: currentUser.id
        };

        let error;
        if (isEditingProduk && editingProdukId) {
            const { error: updateError } = await supabaseClient.from('produk').update(produkData).eq('id', editingProdukId);
            error = updateError;
        } else {
            const { error: insertError } = await supabaseClient.from('produk').insert([produkData]);
            error = insertError;
        }
        if (error) {
            console.error('Error menyimpan produk:', error);
            alert('Gagal menyimpan produk!');
        } else {
            alert(`Produk berhasil ${isEditingProduk ? 'diperbarui' : 'disimpan'}!`);
            resetFormHpp();
            await loadProduk();
        }
    };

    const loadProduk = async () => {
        const { data, error } = await supabaseClient.from('produk').select('*').order('created_at', { ascending: false });
        if (error) { console.error('Error mengambil data produk:', error); return; }
        
        const produkJadi = data.filter(p => p.jenis_produk === 'Produk Jadi');
        produkSetengahJadiList = data.filter(p => p.jenis_produk === 'Produk Setengah Jadi');

        produkTableBody.innerHTML = '';
        produkJadi.forEach(produk => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${produk.nama_produk}</td>
                <td>${produk.kategori || '-'}</td>
                <td>${formatRupiah(produk.harga_jual_aktual)}</td>
                <td>
                    <button class="button-edit" data-id="${produk.id}">Edit</button>
                    <button class="button-delete" data-id="${produk.id}">Hapus</button>
                </td>
            `;
            produkTableBody.appendChild(row);
        });
    };

    const hapusProduk = async (id) => {
        if (confirm("Yakin mau hapus produk ini beserta resepnya?")) {
            const { error } = await supabaseClient.from('produk').delete().eq('id', id);
            if (error) { console.error('Error menghapus produk:', error); alert('Gagal menghapus produk!'); } 
            else { loadProduk(); }
        }
    };

    const editProduk = async (id) => {
        const { data: produk, error } = await supabaseClient.from('produk').select('*').eq('id', id).single();
        if (error) { console.error('Error mengambil data produk:', error); return; }
        isEditingProduk = true;
        editingProdukId = id;
        produkNamaInput.value = produk.nama_produk;
        produkKategoriInput.value = produk.kategori || 'Minuman';
        jenisProdukInput.value = produk.jenis_produk || 'Produk Jadi';
        hasilJadiJumlahInput.value = produk.hasil_jadi_jumlah || '';
        hasilJadiSatuanInput.value = produk.hasil_jadi_satuan || '';
        overheadCostInput.value = produk.overhead_cost || 0;
        overheadTypeInput.value = produk.overhead_cost_type || 'nominal';
        laborCostInput.value = produk.labor_cost || 0;
        errorCostPercentInput.value = produk.error_cost_percent || 0;
        targetMarginPercentInput.value = produk.target_margin_percent || 0;
        hargaJualAktualInput.value = produk.harga_jual_aktual || 0;
        resepTableBody.innerHTML = '';
        if (produk.resep) {
            produk.resep.forEach(item => {
                const listToSearch = item.source === 'bahan_baku' ? masterBahanList : produkSetengahJadiList;
                const bahan = listToSearch.find(b => b.id === item.bahan_id);
                if (bahan) {
                    addBahanFromModal(bahan, item.jumlah);
                }
            });
        }
        updatePerhitunganTotal();
        toggleKalkulatorMode();
        mainNav.querySelector('[data-page="page-kalkulator"]').click();
        document.getElementById('kalkulator-container').scrollIntoView({ behavior: 'smooth' });
    };

    const resetFormHpp = () => {
        isEditingProduk = false;
        editingProdukId = null;
        hppForm.reset();
        resepTableBody.innerHTML = '';
        toggleKalkulatorMode();
        updatePerhitunganTotal();
    };

    const toggleKalkulatorMode = () => {
        const tipe = jenisProdukInput.value;
        if (tipe === 'Produk Setengah Jadi') {
            hasilJadiContainer.classList.remove('hidden');
            hargaJualContainer.classList.add('hidden');
            saranHargaWrapper.classList.add('hidden');
        } else {
            hasilJadiContainer.classList.add('hidden');
            hargaJualContainer.classList.remove('hidden');
            saranHargaWrapper.classList.remove('hidden');
        }
    };

    const openPilihBahanModal = () => {
        tampilkanHasilPencarian();
        pilihBahanModal.classList.remove('hidden');
        searchBahanInput.value = '';
        searchBahanInput.focus();
    };

    const tampilkanHasilPencarian = (query = '', source = 'bahan_baku') => {
        bahanSearchResults.innerHTML = '';
        const listToSearch = source === 'bahan_baku' ? masterBahanList : produkSetengahJadiList;
        const filteredList = listToSearch.filter(item => item.nama && item.nama.toLowerCase().includes(query.toLowerCase()));
        if (filteredList.length === 0) {
            bahanSearchResults.innerHTML = '<li>Bahan tidak ditemukan.</li>';
            return;
        }
        filteredList.forEach(item => {
            const li = document.createElement('li');
            li.dataset.id = item.id;
            li.dataset.source = source;
            li.dataset.nama = item.nama;
            let hargaPerSatuanDasar = 0;
            let satuan = '';
            if(source === 'bahan_baku'){
                if(item.isi_kemasan > 0) hargaPerSatuanDasar = item.harga_beli_kemasan / item.isi_kemasan;
                satuan = item.satuan_kemasan;
            } else {
                const hppBahanBiang = hitungHppProduk(item);
                if(item.hasil_jadi_jumlah > 0) hargaPerSatuanDasar = hppBahanBiang / item.hasil_jadi_jumlah;
                satuan = item.hasil_jadi_satuan;
            }
            li.innerHTML = `<span>${item.nama}</span><small>${formatRupiah(hargaPerSatuanDasar)} / ${satuan}</small>`;
            bahanSearchResults.appendChild(li);
        });
    };

    const hitungHppProduk = (produk) => {
        if (!produk || !produk.resep) return 0;
        return produk.resep.reduce((total, item) => {
            const listToSearch = item.source === 'bahan_baku' ? masterBahanList : produkSetengahJadiList;
            const bahan = listToSearch.find(b => b.id === item.bahan_id);
            if (!bahan) return total;

            let hargaPerSatuan = 0;
            if (item.source === 'bahan_baku') {
                if (bahan.isi_kemasan > 0) hargaPerSatuan = bahan.harga_beli_kemasan / bahan.isi_kemasan;
            } else {
                const hppBahanBiang = hitungHppProduk(bahan);
                if (bahan.hasil_jadi_jumlah > 0) hargaPerSatuan = hppBahanBiang / bahan.hasil_jadi_jumlah;
            }
            return total + (item.jumlah * hargaPerSatuan);
        }, 0);
    };


    // === EVENT LISTENERS ===
    const setupEventListeners = () => {
        if (signupForm) { signupForm.addEventListener('submit', async (event) => { event.preventDefault(); const email = document.getElementById('signup-email').value; const password = document.getElementById('signup-password').value; const { error } = await supabaseClient.auth.signUp({ email, password }); if (error) { alert('Error mendaftar: ' + error.message); } else { alert('Pendaftaran berhasil! Cek email untuk verifikasi.'); } }); }
        if (loginForm) { loginForm.addEventListener('submit', async (event) => { event.preventDefault(); const email = document.getElementById('login-email').value; const password = document.getElementById('login-password').value; const { error } = await supabaseClient.auth.signInWithPassword({ email, password }); if (error) { alert('Error login: ' + error.message); } }); }
        if (logoutButton) { logoutButton.addEventListener('click', async () => { await supabaseClient.auth.signOut(); }); }
        if (masterBahanForm) { masterBahanForm.addEventListener('submit', (e) => simpanBahanBaku(e, false)); }
        if (masterBahanCepatForm) { masterBahanCepatForm.addEventListener('submit', (e) => simpanBahanBaku(e, true)); }
        if (masterBahanTableBody) { masterBahanTableBody.addEventListener('click', (event) => { if (event.target.classList.contains('button-delete')) { hapusBahanBaku(event.target.getAttribute('data-id')); } if (event.target.classList.contains('button-edit')) { openEditModal(event.target.getAttribute('data-id')); } }); }
        if (editBahanForm) { editBahanForm.addEventListener('submit', simpanPerubahanBahan); }
        if (cancelEditBtn) { cancelEditBtn.addEventListener('click', () => { editModal.classList.add('hidden'); }); }
        if (addResepItemBtn) { addResepItemBtn.addEventListener('click', openPilihBahanModal); }
        if (hppForm) { hppForm.addEventListener('submit', simpanProduk); }
        if (produkTableBody) { produkTableBody.addEventListener('click', (event) => { const target = event.target; const id = target.getAttribute('data-id'); if (target.classList.contains('button-delete')) { hapusProduk(id); } if (target.classList.contains('button-edit')) { editProduk(id); } }); }
        if (resetHppBtn) { resetHppBtn.addEventListener('click', resetFormHpp); }
        if (cancelPilihBahanBtn) { cancelPilihBahanBtn.addEventListener('click', () => pilihBahanModal.classList.add('hidden')); }
        if (buatBahanBaruCepatBtn) { buatBahanBaruCepatBtn.addEventListener('click', () => tambahBahanCepatModal.classList.remove('hidden')); }
        if (cancelTambahCepatBtn) { cancelTambahCepatBtn.addEventListener('click', () => tambahBahanCepatModal.classList.add('hidden')); }
        if (searchBahanInput) { searchBahanInput.addEventListener('input', () => tampilkanHasilPencarian(searchBahanInput.value, document.querySelector('.bahan-source-btn.active').dataset.source)); }
        if (bahanSourceTabs) { bahanSourceTabs.addEventListener('click', (event) => { if (event.target.classList.contains('bahan-source-btn')) { bahanSourceTabs.querySelectorAll('.bahan-source-btn').forEach(btn => btn.classList.remove('active')); event.target.classList.add('active'); tampilkanHasilPencarian(searchBahanInput.value, event.target.dataset.source); } }); }
        if (bahanSearchResults) { bahanSearchResults.addEventListener('click', (event) => { const targetLi = event.target.closest('li'); if (targetLi && targetLi.dataset.id) { const bahan = { id: targetLi.dataset.id, nama: targetLi.dataset.nama, source: targetLi.dataset.source, }; addBahanFromModal(bahan); pilihBahanModal.classList.add('hidden'); } }); }
        if (jenisProdukInput) { jenisProdukInput.addEventListener('change', toggleKalkulatorMode); }

        const calculationInputs = [overheadCostInput, overheadTypeInput, laborCostInput, errorCostPercentInput, targetMarginPercentInput, hargaJualAktualInput];
        calculationInputs.forEach(element => { if (element) { element.addEventListener('input', updatePerhitunganTotal); element.addEventListener('change', updatePerhitunganTotal); } });
        if (resepTableBody) {
            resepTableBody.addEventListener('input', (event) => { if (event.target.classList.contains('jumlah-resep')) { updatePerhitunganTotal(); } });
            resepTableBody.addEventListener('click', (event) => { if (event.target.classList.contains('hapus-resep-item')) { event.target.closest('tr').remove(); updatePerhitunganTotal(); } });
        }
        if (mainNav) {
            mainNav.addEventListener('click', (event) => {
                if (event.target.classList.contains('nav-button')) {
                    const targetPageId = event.target.getAttribute('data-page');
                    pages.forEach(page => page.classList.remove('active'));
                    mainNav.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('active'));
                    document.getElementById(targetPageId).classList.add('active');
                    event.target.classList.add('active');
                    if(targetPageId === 'page-kalkulator') resetFormHpp();
                }
            });
        }
    };
    
    // === INISIALISASI APLIKASI ===
    const initApp = async () => {
        setupEventListeners();
        const { data: { session } } = await supabaseClient.auth.getSession();
        updateUI(session?.user);
        supabaseClient.auth.onAuthStateChange((_event, session) => {
            updateUI(session?.user);
        });
    };

    initApp();
});
